<!DOCTYPE html>
<html lang="id">
<head>
    <!-- [ANALYTICS GOATCOUNTER] -->
    <script data-goatcounter="https://comsrp.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
    <!-- [AKHIR ANALYTICS] -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#047857">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Jadwal Sholat">
    <meta name="apple-mobile-web-app-title" content="Jadwal Sholat">
    
    <!-- Link Manifest (Data URI untuk Single File PWA) -->
    <link rel="manifest" id="manifest-placeholder">

    <title>Jadwal Sholat Digital - Standar Kemenag RI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        
        .bg-mosque {
            background: linear-gradient(135deg, #047857 0%, #064e3b 100%);
            position: relative;
            overflow: hidden;
        }
        
        .bg-pattern {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            opacity: 0.1;
            background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%23ffffff" fill-opacity="1"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
        }

        /* Scrollbar styling halus */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .loading-dots:after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60% { content: ' ...'; }
            80%, 100% { content: ''; }
        }

        /* Styles untuk Kompas */
        .compass-container {
            position: relative;
            width: 260px;
            height: 260px;
            border-radius: 50%;
            background: #f8fafc;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1), inset 0 0 20px rgba(0,0,0,0.05);
            border: 8px solid #cbd5e1;
            will-change: transform;
            transition: none;
        }
        
        /* Jarum Kiblat (Merah) */
        .compass-arrow-qibla {
            position: absolute;
            top: 50%; left: 50%;
            width: 4px; height: 110px;
            background: linear-gradient(to bottom, #ef4444, #b91c1c);
            transform-origin: bottom center;
            border-radius: 4px;
            margin-left: -2px; margin-top: -110px;
            z-index: 10;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
        }
        
        .compass-arrow-qibla::after {
            content: '';
            position: absolute;
            top: -12px; left: -8px;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 18px solid #ef4444;
        }

        .compass-center {
            position: absolute;
            top: 50%; left: 50%;
            width: 12px; height: 12px;
            background: #1e293b;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .compass-directions {
            position: absolute;
            width: 100%; height: 100%;
            font-weight: bold;
            color: #cbd5e1;
            font-family: monospace;
        }
        .dir-n { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); color: #ef4444; font-size: 1.2rem; }
        .dir-s { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); }
        .dir-e { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); }
        .dir-w { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); }

        #installBtn { display: none; }
    </style>
</head>
<body class="bg-slate-200 h-screen md:h-screen h-[100dvh] flex items-center justify-center overflow-hidden">

    <!-- Container Utama -->
    <div class="w-full h-full md:h-[95vh] md:max-h-[800px] md:w-auto md:aspect-[16/9] bg-white md:rounded-3xl shadow-2xl overflow-hidden relative flex flex-col md:flex-row">
        
        <!-- BAGIAN 1: JAM & INFO (ATAS/KIRI) -->
        <div class="h-[40%] md:h-full md:w-5/12 bg-mosque relative z-10 flex flex-col justify-center items-center p-4 text-center flex-shrink-0">
            <div class="bg-pattern"></div>
            
            <!-- Lokasi Dinamis -->
            <div id="locationBadge" class="relative z-10 flex items-center justify-center gap-2 mb-2 md:mb-6 opacity-90 bg-emerald-800/30 px-4 py-1 rounded-full text-white cursor-pointer hover:bg-emerald-800/50 transition max-w-[90%] md:max-w-[80%]" onclick="requestLocation()">
                <i id="locationIcon" class="fas fa-map-pin text-emerald-300 text-xs md:text-sm flex-shrink-0"></i>
                <h2 id="locationName" class="font-medium tracking-wide text-[11px] md:text-sm uppercase truncate">KABUPATEN TUBAN</h2>
            </div>

            <!-- Tombol Action Khusus Mobile -->
            <div class="flex md:hidden gap-2 mb-2 z-20">
                <button onclick="openQiblaModal()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm border border-white/40 text-white text-[10px] px-3 py-1 rounded-full flex items-center gap-1 transition shadow-sm">
                   <i class="fas fa-compass"></i> Arah Kiblat
               </button>
               <button onclick="requestLocation()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm border border-white/40 text-white text-[10px] px-3 py-1 rounded-full flex items-center gap-1 transition shadow-sm">
                   <i class="fas fa-sync-alt"></i>
               </button>
               <button onclick="openInfoModal()" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm border border-white/40 text-white text-[10px] px-3 py-1 rounded-full flex items-center gap-1 transition shadow-sm">
                   <i class="fas fa-info-circle"></i> Info
               </button>
               <!-- Install PWA Button (Hidden by default) -->
               <button id="installBtnMobile" class="hidden bg-emerald-500 hover:bg-emerald-600 text-white text-[10px] px-3 py-1 rounded-full flex items-center gap-1 transition shadow-sm animate-pulse">
                   <i class="fas fa-download"></i> App
               </button>
           </div>

            <!-- Jam Digital -->
            <div class="relative z-10 mb-2 md:mb-8 text-white">
                <div class="text-5xl md:text-7xl font-bold tracking-tighter drop-shadow-lg leading-none" id="digitalClock">
                    00<span class="blink">:</span>00
                </div>
                <div class="text-emerald-200 text-xs md:text-base mt-1 md:mt-2 font-medium" id="currentDate">Memuat...</div>
                <div class="text-[10px] md:text-xs text-emerald-300 italic" id="hijriDate">...</div>
            </div>

            <!-- Countdown Box -->
            <div class="relative z-10 glass-panel rounded-xl p-2 md:p-6 w-4/5 max-w-xs transform md:hover:scale-105 transition duration-300 text-white mt-1">
                <p class="text-[10px] md:text-xs text-emerald-100 uppercase tracking-widest mb-1 border-b border-emerald-500/50 pb-1">Menuju <span id="nextPrayerName" class="font-bold">...</span></p>
                <p class="text-xl md:text-4xl font-bold font-mono tracking-wider" id="countdownTimer">--:--:--</p>
            </div>
            
            <!-- Footer Validasi (Visible on Mobile & Desktop) -->
            <div class="absolute bottom-2 md:bottom-4 text-[9px] md:text-[10px] text-emerald-200/90 md:text-emerald-400/60 flex items-center gap-1 cursor-pointer hover:text-white transition z-20" onclick="openInfoModal()">
                <i class="fas fa-check-circle mr-1"></i> Sesuai Standar Kemenag RI • Koordinat Presisi
            </div>
        </div>

        <!-- BAGIAN 2: DAFTAR JADWAL (BAWAH/KANAN) -->
        <div class="flex-1 md:h-full md:w-7/12 bg-white relative z-20 flex flex-col min-h-0">
            
            <!-- Header List (Desktop Only) -->
            <div class="hidden md:block p-6 pb-2 border-b border-gray-100 flex justify-between items-end flex-shrink-0">
                <div>
                    <h3 class="text-xl font-bold text-gray-800">Jadwal Hari Ini</h3>
                    <div class="flex items-center gap-1 text-sm text-gray-500 mt-1">
                        <i class="fas fa-shield-alt text-emerald-600"></i>
                        <span>Metode Hisab Kemenag RI</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="installBtnDesktop" class="hidden text-xs bg-emerald-600 text-white px-3 py-1.5 rounded-full hover:bg-emerald-700 font-medium transition flex items-center gap-1">
                        <i class="fas fa-download"></i> Install App
                    </button>
                    <button onclick="openInfoModal()" class="text-xs text-gray-500 hover:text-emerald-600 font-medium px-2 py-1.5 transition">
                        <i class="fas fa-info-circle mr-1"></i> Sumber Data
                    </button>
                    <button onclick="openQiblaModal()" class="text-xs bg-emerald-100 text-emerald-700 px-3 py-1.5 rounded-full hover:bg-emerald-200 font-medium transition flex items-center gap-1">
                        <i class="fas fa-compass"></i> Arah Kiblat
                    </button>
                    <button onclick="requestLocation()" class="text-xs text-emerald-600 hover:text-emerald-800 font-medium px-2 py-1.5" title="Perbarui Lokasi GPS">
                        <i class="fas fa-location-crosshairs mr-1"></i> Update
                    </button>
                </div>
            </div>

            <!-- List Container -->
            <div class="flex-1 overflow-y-auto p-3 md:p-8 relative bg-white min-h-0">
                <div id="loading" class="text-center py-10 text-gray-400">
                    <i class="fas fa-circle-notch fa-spin fa-2x mb-3 text-emerald-500"></i>
                    <p class="animate-pulse text-xs">Sinkronisasi Standar Kemenag...</p>
                </div>

                <div id="scheduleList" class="space-y-2 md:space-y-3 hidden h-full flex flex-col justify-center md:justify-start">
                    <!-- Item Jadwal render di sini -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL KOMPAS -->
    <div id="qiblaModal" class="fixed inset-0 z-50 bg-slate-900/95 hidden flex flex-col items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
        <button onclick="closeQiblaModal()" class="absolute top-4 right-4 text-white/70 hover:text-white text-2xl w-10 h-10 flex items-center justify-center bg-white/10 rounded-full">
            <i class="fas fa-times"></i>
        </button>
        
        <h3 class="text-white text-xl font-bold mb-1">Pencari Arah Kiblat</h3>
        <p class="text-emerald-300 text-xs mb-6 text-center max-w-xs animate-pulse">Lakukan gerakan angka 8 (∞) untuk kalibrasi.</p>
        
        <div class="relative">
            <div id="compassDisk" class="compass-container">
                <div class="compass-directions">
                    <span class="dir-n">N</span>
                    <span class="dir-e">E</span>
                    <span class="dir-s">S</span>
                    <span class="dir-w">W</span>
                    <div class="absolute inset-0 border-4 border-slate-200 rounded-full opacity-30"></div>
                </div>
                <div id="qiblaArrow" class="compass-arrow-qibla"></div>
                <div class="compass-center"></div>
            </div>
            <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-white/30 text-xs">
                <i class="fas fa-mobile-alt"></i> Depan HP
            </div>
        </div>

        <div class="mt-8 text-center text-white">
            <div class="flex justify-center items-baseline gap-2">
                <div class="text-4xl font-mono font-bold text-emerald-400" id="qiblaDegreeDisplay">--°</div>
            </div>
            <p class="text-xs text-gray-400 mt-1">Sudut Kiblat (Relatif Utara)</p>
            
            <div class="mt-4 p-3 bg-white/10 rounded-lg text-xs text-left max-w-xs mx-auto border border-white/10">
                <div class="flex justify-between mb-1">
                    <span class="text-gray-400">Jarak:</span>
                    <span id="qiblaDistance" class="font-mono text-emerald-300">...</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400">Sensor:</span>
                    <span id="compassStatus" class="font-bold text-yellow-500">Menunggu...</span>
                </div>
            </div>
        </div>
        
        <button id="iosPermButton" onclick="requestCompassPermission()" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-full text-sm font-semibold shadow-lg hidden transition transform active:scale-95">
            <i class="fas fa-compass mr-2"></i> Izinkan Akses Sensor
        </button>
    </div>

    <!-- MODAL INFO (NEW) -->
    <div id="infoModal" class="fixed inset-0 z-50 bg-black/60 hidden flex flex-col items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl relative">
            <button onclick="closeInfoModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
                <i class="fas fa-times text-xl"></i>
            </button>
            
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3 text-emerald-600">
                    <i class="fas fa-check-double text-xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800">Validasi & Sumber Data</h3>
            </div>
            
            <div class="space-y-4 text-sm text-gray-600">
                <div class="flex gap-3">
                    <i class="fas fa-university text-emerald-500 mt-1 flex-shrink-0"></i>
                    <div>
                        <p class="font-bold text-gray-800">Standar Kemenag RI</p>
                        <p class="text-xs leading-relaxed">Perhitungan menggunakan metode hisab resmi Kementerian Agama Republik Indonesia (Sudut Subuh 20°, Isya 18°).</p>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <i class="fas fa-satellite-dish text-emerald-500 mt-1 flex-shrink-0"></i>
                    <div>
                        <p class="font-bold text-gray-800">Akurasi GPS Presisi</p>
                        <p class="text-xs leading-relaxed">Jadwal dihitung berdasarkan koordinat <strong>spesifik lokasi Anda berdiri</strong>. Ini lebih akurat dibanding jadwal cetak yang biasanya hanya mengambil satu titik pusat kota/kabupaten.</p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <i class="fas fa-exclamation-triangle text-amber-500 mt-1 flex-shrink-0"></i>
                    <div>
                        <p class="font-bold text-gray-800">Ihtiyat (Kehati-hatian)</p>
                        <p class="text-xs leading-relaxed">Waktu yang ditampilkan adalah hasil hisab murni. Sesuai anjuran ulama, Anda dapat menambahkan waktu <strong>+2 menit</strong> sebagai langkah kehati-hatian.</p>
                    </div>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t border-gray-100 text-center">
                <p class="text-[10px] text-gray-400">Data provided by Aladhan API (Method 20)</p>
                <p class="text-[10px] text-gray-400 mt-1">
                    Developer : <a href="https://t.me/srpcomadmin" target="_blank" class="hover:text-blue-600 transition-colors"><i class="fab fa-telegram text-blue-500"></i> @srpcomadmin</a>
                </p>
                <button onclick="closeInfoModal()" class="mt-4 w-full bg-emerald-600 text-white py-2 rounded-lg font-medium hover:bg-emerald-700 transition">Mengerti</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT PWA & APPS -->
    <script>
        // --- 1. SETUP PWA MANIFEST & SERVICE WORKER ---
        
        // Pilihan Favicon 1: Masjid Modern (Rekomendasi)
        const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <rect width="512" height="512" rx="128" fill="#047857"/>
            <path d="M384 240H356.3C349.3 190.5 306.9 152 256 152C205.1 152 162.7 190.5 155.7 240H128C114.7 240 104 250.7 104 264V408C104 421.3 114.7 432 128 432H384C397.3 432 408 421.3 408 408V264C408 250.7 397.3 240 384 240ZM256 184C282.2 184 304.6 201.7 311.9 225.6C312.8 228.4 313.3 231.4 313.3 234.4V240H198.7V234.4C198.7 231.4 199.2 228.4 200.1 225.6C207.4 201.7 229.8 184 256 184V184Z" fill="white"/>
            <circle cx="256" cy="112" r="24" fill="white"/>
            <rect x="246" y="72" width="20" height="40" rx="10" fill="white"/>
        </svg>`;
        
        const iconBlob = new Blob([iconSvg], {type: 'image/svg+xml'});
        const iconUrl = URL.createObjectURL(iconBlob);

        const manifest = {
            "name": "Jadwal Sholat Digital",
            "short_name": "Jadwal Sholat",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#047857",
            "orientation": "portrait",
            "icons": [
                { "src": "https://cdn-icons-png.flaticon.com/512/3655/3655163.png", "sizes": "192x192", "type": "image/png" },
                { "src": "https://cdn-icons-png.flaticon.com/512/3655/3655163.png", "sizes": "512x512", "type": "image/png" }
            ]
        };
        
        const stringManifest = JSON.stringify(manifest);
        const blobManifest = new Blob([stringManifest], {type: 'application/json'});
        document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(blobManifest));

        // --- 2. LOGIKA UTAMA APLIKASI ---
        const DEFAULT_CITY = 'Tuban';
        const CALCULATION_METHOD = 20; 
        const KAABA_LAT = 21.422487;
        const KAABA_LONG = 39.826206;

        let todaySchedule = {};
        let isUsingGPS = false;
        let currentLat = -6.89; 
        let currentLong = 112.06;
        let qiblaAngle = 0; 
        
        // --- LOGIKA KOMPAS ---
        let currentHeading = 0;
        let targetHeading = 0;
        let isCompassRunning = false;
        let compassAnimationId = null;

        const prayerNames = { 'Imsak': 'Imsak', 'Fajr': 'Subuh', 'Sunrise': 'Terbit', 'Dhuhr': 'Dzuhur', 'Asr': 'Ashar', 'Maghrib': 'Maghrib', 'Isha': 'Isya' };
        const prayerIcons = { 'Imsak': 'fa-moon', 'Fajr': 'fa-cloud-sun', 'Sunrise': 'fa-sun', 'Dhuhr': 'fa-sun', 'Asr': 'fa-cloud-sun', 'Maghrib': 'fa-cloud-moon', 'Isha': 'fa-moon' };

        document.addEventListener('DOMContentLoaded', () => {
            fetchDefaultLocation();
            requestLocation(true); 
            setInterval(updateClock, 1000);
            updateClock();
            
            // Setup install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installBtnMobile').classList.remove('hidden');
                document.getElementById('installBtnDesktop').classList.remove('hidden');
            });
        });

        // --- INFO MODAL HANDLER ---
        function openInfoModal() {
            document.getElementById('infoModal').classList.remove('hidden');
        }
        function closeInfoModal() {
            document.getElementById('infoModal').classList.add('hidden');
        }

        // --- FUNGSI LOKASI & JADWAL ---
        async function fetchDefaultLocation() {
            if (isUsingGPS) return;
            updateUIState(false, "Kabupaten Tuban");
            calculateQibla(currentLat, currentLong);
            const url = `https://api.aladhan.com/v1/timingsByCity?city=${DEFAULT_CITY}&country=Indonesia&method=${CALCULATION_METHOD}`;
            await executeFetch(url);
        }

        function requestLocation(isSilent = false) {
            if (!navigator.geolocation) {
                if(!isSilent) alert("Browser tidak mendukung GPS.");
                return;
            }
            if(!isSilent) {
                const nameEl = document.getElementById('locationName');
                nameEl.textContent = "Mencari...";
                nameEl.classList.add('loading-dots');
            }
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    isUsingGPS = true;
                    currentLat = position.coords.latitude;
                    currentLong = position.coords.longitude;
                    fetchByCoordinates(currentLat, currentLong);
                    getDetailedLocationName(currentLat, currentLong);
                    calculateQibla(currentLat, currentLong);
                },
                (error) => {
                    document.getElementById('locationName').classList.remove('loading-dots');
                    if(!isSilent && !isUsingGPS) { alert("Gagal mendeteksi lokasi. Pastikan GPS aktif."); fetchDefaultLocation(); }
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        async function fetchByCoordinates(lat, long) {
            const timestamp = Math.floor(Date.now() / 1000);
            const url = `https://api.aladhan.com/v1/timings/${timestamp}?latitude=${lat}&longitude=${long}&method=${CALCULATION_METHOD}`;
            await executeFetch(url);
        }

        async function getDetailedLocationName(lat, long) {
            try {
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${long}&zoom=18&addressdetails=1`;
                const response = await fetch(url);
                const data = await response.json();
                let displayName = "LOKASI TERDETEKSI";
                if(data && data.address) {
                    const addr = data.address;
                    const village = addr.village || addr.suburb || addr.neighbourhood;
                    const district = addr.city_district || addr.district || addr.subdistrict; 
                    const city = addr.city || addr.regency || addr.town;
                    let parts = [];
                    if (village) parts.push(village.replace("Kelurahan ", "").replace("Desa ", "")); 
                    if (district) parts.push("Kec. " + district);
                    if (parts.length < 2 && city) parts.push(city.replace("Kabupaten ", "Kab. ").replace("Kota ", ""));
                    if (parts.length > 0) displayName = parts.join(', '); else if (city) displayName = city;
                }
                updateUIState(true, displayName.toUpperCase());
            } catch (e) { console.error(e); }
        }

        function updateUIState(isGps, name) {
            const locName = document.getElementById('locationName');
            const locIcon = document.getElementById('locationIcon');
            // sourceInfo updated via CSS/HTML directly
            locName.classList.remove('loading-dots');
            locName.textContent = name;
            if(isGps) {
                locIcon.className = "fas fa-location-dot text-emerald-300 animate-pulse";
            } else {
                locIcon.className = "fas fa-map-pin text-emerald-300";
            }
        }
        
        function calculateQibla(lat, lng) {
            const PI = Math.PI;
            const latk = KAABA_LAT * PI / 180;
            const longk = KAABA_LONG * PI / 180;
            const phi = lat * PI / 180;
            const lambda = lng * PI / 180;
            const y = Math.sin(longk - lambda);
            const x = Math.cos(phi) * Math.tan(latk) - Math.sin(phi) * Math.cos(longk - lambda);
            qiblaAngle = (Math.atan2(y, x) * 180 / PI + 360) % 360; 
            
            // Hitung Jarak
            const R = 6371; 
            const dLat = (KAABA_LAT - lat) * PI / 180;
            const dLon = (KAABA_LONG - lng) * PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat * PI / 180) * Math.cos(KAABA_LAT * PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            document.getElementById('qiblaDegreeDisplay').textContent = Math.round(qiblaAngle) + "°";
            document.getElementById('qiblaDistance').textContent = `${Math.round(R * c).toLocaleString()} km`;
            
            document.getElementById('qiblaArrow').style.transform = `translateX(-50%) rotate(${qiblaAngle}deg)`;
        }

        // --- SISTEM KOMPAS SMOOTH ---
        function smoothCompass() {
            if (!isCompassRunning) return;
            
            let diff = targetHeading - currentHeading;
            while (diff < -180) diff += 360;
            while (diff > 180) diff -= 360;
            
            if (Math.abs(diff) > 0.1) {
                const smoothingFactor = 0.05; 
                currentHeading += diff * smoothingFactor;
                const disk = document.getElementById('compassDisk');
                if(disk) disk.style.transform = `rotate(${-currentHeading}deg)`;
            }
            
            compassAnimationId = requestAnimationFrame(smoothCompass);
        }

        function handleOrientation(event) {
            let heading = null;
            if (event.webkitCompassHeading) {
                heading = event.webkitCompassHeading;
            } else if (event.absolute === true && typeof event.alpha !== 'undefined') {
                heading = 360 - event.alpha;
            } else if (typeof event.alpha !== 'undefined') {
                heading = 360 - event.alpha;
            }
            if (heading == null) return;
            targetHeading = (heading + 360) % 360;
            updateStatusText(event.absolute, event.webkitCompassHeading);
        }
        
        function updateStatusText(isAbsolute, isIOS) {
            const el = document.getElementById('compassStatus');
            el.classList.remove('text-yellow-500', 'text-red-500', 'text-green-500');
            if (isIOS) {
                el.textContent = "Sensor iOS (Akurat)";
                el.classList.add('text-green-400');
            } else if (isAbsolute) {
                el.textContent = "Magnetometer (Akurat)";
                el.classList.add('text-green-400');
            } else {
                el.textContent = "Sensor Relatif (Kurang Akurat)";
                el.classList.add('text-yellow-500');
            }
        }

        function openQiblaModal() {
            if (isCompassRunning) closeQiblaModal();
            document.getElementById('qiblaModal').classList.remove('hidden');
            isCompassRunning = true;
            smoothCompass(); 
            
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                document.getElementById('iosPermButton').classList.remove('hidden');
                document.getElementById('compassStatus').textContent = "Perlu Izin iOS";
            } else {
                if ('ondeviceorientationabsolute' in window) {
                    window.addEventListener('deviceorientationabsolute', handleOrientation, true);
                } 
                window.addEventListener('deviceorientation', handleOrientation, true);
            }
            calculateQibla(currentLat, currentLong);
        }

        function closeQiblaModal() {
            document.getElementById('qiblaModal').classList.add('hidden');
            isCompassRunning = false;
            cancelAnimationFrame(compassAnimationId);
            window.removeEventListener('deviceorientation', handleOrientation);
            if ('ondeviceorientationabsolute' in window) {
                window.removeEventListener('deviceorientationabsolute', handleOrientation);
            }
        }

        function requestCompassPermission() {
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        document.getElementById('iosPermButton').classList.add('hidden');
                        window.addEventListener('deviceorientation', handleOrientation, true);
                    } else {
                        alert('Izin sensor ditolak. Kompas tidak dapat bekerja.');
                    }
                })
                .catch(console.error);
        }

        // --- FETCH UTILS ---
        let deferredPrompt;
        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('installBtnMobile').classList.add('hidden');
                document.getElementById('installBtnDesktop').classList.add('hidden');
            }
        }
        document.getElementById('installBtnMobile').addEventListener('click', installApp);
        document.getElementById('installBtnDesktop').addEventListener('click', installApp);

        async function executeFetch(url) {
            try {
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('scheduleList').classList.add('hidden');
                const response = await fetch(url);
                const data = await response.json();
                if (data.code === 200) {
                    todaySchedule = data.data.timings;
                    const dateInfo = data.data.date;
                    document.getElementById('currentDate').textContent = dateInfo.readable;
                    document.getElementById('hijriDate').textContent = `${dateInfo.hijri.day} ${dateInfo.hijri.month.en} ${dateInfo.hijri.year} H`;
                    renderSchedule(todaySchedule);
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('scheduleList').classList.remove('hidden');
                    updateClock(); 
                }
            } catch (error) { console.error("Fetch Error:", error); }
        }

        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('digitalClock').innerHTML = `${hours}<span class="blink">:</span>${minutes}`;
            if (Object.keys(todaySchedule).length > 0) updateCountdown(now);
        }

        function renderSchedule(timings) {
            const listContainer = document.getElementById('scheduleList');
            listContainer.innerHTML = '';
            const relevantTimes = ['Imsak', 'Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            relevantTimes.forEach(key => {
                const time = timings[key];
                const div = document.createElement('div');
                div.className = `group flex justify-between items-center px-4 py-2 md:p-4 rounded-lg md:rounded-xl transition-all duration-300 border border-gray-100 hover:border-emerald-200 cursor-default ${key}-row`;
                div.id = `row-${key}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3 md:gap-4">
                        <div class="w-8 h-8 md:w-12 md:h-12 rounded-full bg-emerald-50 group-hover:bg-emerald-100 transition-colors flex items-center justify-center text-emerald-600">
                            <i class="fas ${prayerIcons[key]} text-xs md:text-lg"></i>
                        </div>
                        <span class="font-semibold text-gray-700 text-sm md:text-lg">${prayerNames[key]}</span>
                    </div>
                    <span class="font-bold text-gray-800 text-sm md:text-xl font-mono tracking-wide">${time}</span>
                `;
                listContainer.appendChild(div);
            });
        }

        function updateCountdown(now) {
            const currentTimeStr = now.toTimeString().slice(0, 5); 
            let nextPrayer = null;
            let nextPrayerTimeDate = null;
            const relevantTimes = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha']; 
            document.querySelectorAll('[id^="row-"]').forEach(el => {
                el.classList.remove('bg-emerald-600', 'text-white', 'shadow-lg', 'scale-[1.02]', 'md:scale-105');
                el.classList.add('bg-white', 'text-gray-800');
                const iconBox = el.querySelector('.rounded-full');
                iconBox.classList.remove('bg-emerald-50', 'text-emerald-600');
                iconBox.classList.add('bg-emerald-50', 'text-emerald-600');
                el.querySelector('.font-semibold').classList.remove('text-white');
                el.querySelector('.font-bold').classList.remove('text-white');
            });
            let foundNext = false;
            for (let key of relevantTimes) {
                const timeStr = todaySchedule[key];
                const [h, m] = timeStr.split(':').map(Number);
                const prayerDate = new Date();
                prayerDate.setHours(h, m, 0, 0); 
                if (prayerDate > now) {
                    nextPrayer = key;
                    nextPrayerTimeDate = prayerDate;
                    foundNext = true;
                    break;
                }
            }
            if (!foundNext) {
                nextPrayer = 'Fajr';
                const timeStr = todaySchedule['Fajr'];
                const [h, m] = timeStr.split(':').map(Number);
                nextPrayerTimeDate = new Date();
                nextPrayerTimeDate.setDate(nextPrayerTimeDate.getDate() + 1);
                nextPrayerTimeDate.setHours(h, m, 0, 0);
            }
            const diff = nextPrayerTimeDate - now;
            if (diff < 0) return;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            document.getElementById('nextPrayerName').textContent = prayerNames[nextPrayer];
            document.getElementById('countdownTimer').textContent = `-${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            const activeRow = document.getElementById(`row-${nextPrayer}`);
            if (activeRow) {
                activeRow.classList.remove('bg-white', 'text-gray-800');
                activeRow.classList.add('bg-emerald-600', 'text-white', 'shadow-lg', 'scale-[1.02]', 'md:scale-105', 'transform');
                const iconBox = activeRow.querySelector('.rounded-full');
                iconBox.classList.remove('bg-emerald-50', 'text-emerald-600');
                iconBox.classList.add('bg-white', 'text-emerald-600');
                activeRow.querySelector('.font-semibold').classList.add('text-white');
                activeRow.querySelector('.font-semibold').classList.remove('text-gray-700');
                activeRow.querySelector('.font-bold').classList.add('text-white');
                activeRow.querySelector('.font-bold').classList.remove('text-gray-800');
            }
        }
    </script>
</body>
</html>
